#include "stm32l432xx.h"

void I2C1Init(void);
void I2C3Init(void);

void clock32MHz(){
	PWR->CR1 |= PWR_CR1_DBP;
	RCC->CR |= RCC_CR_MSIRGSEL;
	RCC->CR = (RCC->CR & ~(0xF << 4)) | RCC_CR_MSIRANGE_10;
}

int main(){
	clock32MHz();
	SystemCoreClockUpdate();
	I2C3Init();
	
	return 0;
}

void I2C3Init(void){
	RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN | RCC_AHB2ENR_GPIOBEN;
	
	//PB4 D12 SDA
	GPIOB->MODER &= ~(GPIO_MODER_MODE4);
	GPIOB->MODER |= 0b10 << GPIO_MODER_MODE4_Pos;
	GPIOB->AFR[0] |= 0x04 << GPIO_AFRL_AFSEL4_Pos;
	
	//PA7 A6 SCL
	GPIOA->MODER &= ~(GPIO_MODER_MODE7);
	GPIOA->MODER |= 0b10 << GPIO_MODER_MODE7_Pos;
	GPIOA->AFR[0] |= 0x04 << GPIO_AFRL_AFSEL7_Pos;
	
	//Open Drain
	GPIOB->OTYPER |= (1 << 4);
	GPIOA->OTYPER |= (1 << 7);
	
	//Pull up
	GPIOB->PUPDR &= ~(GPIO_PUPDR_PUPD4);
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD4_Pos);
	GPIOA->PUPDR &= ~(GPIO_PUPDR_PUPD7);
	GPIOA->PUPDR |= (0b01 << GPIO_PUPDR_PUPD7_Pos);
	
	RCC->CCIPR |= 0x01 << RCC_CCIPR_I2C3SEL_Pos;
	RCC->APB1ENR1 |= RCC_APB1ENR1_I2C3EN;
	
	I2C3->TIMINGR = 0x007F7DBD;//0x30108EFF//0x00B06EA4//0x00707DBD
	I2C3->CR1 |= I2C_CR1_ANFOFF;
	I2C3->CR1 |= I2C_CR1_PE;
	I2C3->CR2 |= 0xD0 << I2C_CR2_SADD_Pos;
	I2C3->CR2 |= I2C_CR2_START;
	while(1);
}

void I2C1Init(void){
	/*RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN; //Enable Port A clock
	
	
	GPIOA->MODER &= ~(GPIO_MODER_MODE9 | GPIO_MODER_MODE10); //Clear 9 and 10 functions
	GPIOA->MODER |= (0x02 << GPIO_MODER_MODE9_Pos) | (0x02 << GPIO_MODER_MODE10_Pos); //set alternate function
	GPIOA->AFR[1] |= (0x04 << GPIO_AFRH_AFSEL9_Pos) | (0x04 << GPIO_AFRH_AFSEL10_Pos); //Set alternate to I2C
	
	GPIOA->OTYPER |= (1 << 9) | (1 << 10);
	//GPIOA->PUPDR |= (0x01 << GPIO_PUPDR_PUPD9_Pos) | (0x01 << GPIO_PUPDR_PUPD10_Pos);*/
	
	
	RCC->AHB2ENR |= RCC_AHB2ENR_GPIOBEN;
	GPIOB->MODER &= ~(GPIO_MODER_MODE6 | GPIO_MODER_MODE7);
	GPIOB->MODER |= (0x02 << GPIO_MODER_MODE6_Pos) | (0x02 << GPIO_MODER_MODE7_Pos);
	GPIOB->AFR[0] |= (0x04 << GPIO_AFRL_AFSEL6_Pos) | (0x04 << GPIO_AFRL_AFSEL7_Pos);
	
	GPIOB->OTYPER |= (1 << 6) | (1 << 7);
//	GPIOB->PUPDR |= (0x01 << GPIO_PUPDR_PUPD6_Pos) | (0x01 << GPIO_PUPDR_PUPD7_Pos);
	
	RCC->CCIPR |= 0x01 << RCC_CCIPR_I2C1SEL_Pos; //Select Sysclock
	RCC->APB1ENR1 |= RCC_APB1ENR1_I2C1EN; //Enable clock
	
	I2C1->TIMINGR = 0x007F7DBD;//0x30108EFF//0x00B06EA4//0x00707DBD
	I2C1->CR1 |= I2C_CR1_ANFOFF;
	I2C1->CR1 |= I2C_CR1_PE;
	I2C1->CR2 |= 0x68 << I2C_CR2_SADD_Pos;
	I2C1->CR2 |= I2C_CR2_START;
	
	//I2C1->TXDR = 0x04;
	while(1);
	
	I2C1->TXDR = 0x01;
	
	I2C1->CR2 |= I2C_CR2_STOP;
	I2C1->CR2 |= I2C_CR2_RD_WRN;
	I2C1->CR2 |= I2C_CR2_START;
	uint8_t data = I2C1->RXDR;
}
